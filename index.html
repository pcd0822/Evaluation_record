<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학생 활동 기반 특기사항 생성기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;
    </script>
    <script src="https://unpkg.com/docx-preview@0.1.15/dist/docx-preview.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Tailwind slate-50 */
        }

        .header-bg {
            background-color: #E7C6FF;
            position: relative;
        }
        
        .hidden {
            display: none;
        }

        .spinner {
            border-top-color: #a855f7; 
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .interactive-section {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        
        @keyframes pop-up {
            0% { transform: scale(1); }
            50% { transform: scale(1.015); }
            100% { transform: scale(1); }
        }

        .animate-pop {
            animation: pop-up 0.3s ease-out forwards;
        }
        
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        #progress-bar {
            background: linear-gradient(-45deg, #f9a8d4, #e9d5ff, #c4b5fd, #a78bfa);
            background-size: 400% 400%;
            animation: gradient-animation 10s ease infinite;
        }
    </style>
</head>

<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        
        <header class="text-center mb-12 rounded-2xl overflow-hidden shadow-lg header-bg">
            <div class="py-12 px-4">
                <h1 class="text-4xl md:text-5xl font-extrabold text-white mb-4 leading-tight">학생 활동 기반 특기사항 생성기</h1>
                <p class="text-lg text-white/90 max-w-2xl mx-auto">AI를 활용하여 학생들의 활동 기록을 의미 있는 특기사항으로 변환하세요.</p>
            </div>
        </header>

        <!-- API 설정 -->
        <section class="interactive-section mb-8 p-6 bg-white rounded-2xl shadow-lg">
            <div class="flex items-center mb-4">
                <i class="fas fa-key text-violet-500 text-xl mr-3"></i>
                <h2 class="text-2xl font-bold">API 설정</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-2">
                    <label for="api-key" class="block text-sm font-medium text-slate-700 mb-1">API 키</label>
                    <input type="password" id="api-key" placeholder="OpenAI 또는 Gemini API 키를 입력하세요" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent">
                </div>
                <div>
                    <label for="api-provider" class="block text-sm font-medium text-slate-700 mb-1">API 선택</label>
                    <select id="api-provider" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent">
                        <option value="openai">OpenAI</option>
                        <option value="gemini">Google Gemini</option>
                    </select>
                </div>
            </div>
            <button id="save-api-key" class="mt-4 w-full md:w-auto bg-violet-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-violet-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500 transition-colors">
                <i class="fas fa-save mr-2"></i>API 키 저장
            </button>
            <p id="api-status" class="text-sm text-green-600 mt-2 ml-1"></p>
        </section>

        <!-- 교육과정-수업 맥락 설정 -->
        <section class="interactive-section mb-8 p-6 bg-white rounded-2xl shadow-lg">
             <div class="flex items-center mb-4">
                <i class="fas fa-sitemap text-indigo-500 text-xl mr-3"></i>
                <h2 class="text-2xl font-bold">교육과정-수업 맥락 설정</h2>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="curriculum-info" class="block text-sm font-medium text-slate-700">관련 교육과정 성취기준 / 단원명 / 학습주제</label>
                    <input type="text" id="curriculum-info" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                <div>
                    <label for="class-activity-info" class="block text-sm font-medium text-slate-700">수업(활동) 내용 소개</label>
                    <textarea id="class-activity-info" rows="3" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"></textarea>
                </div>
            </div>
        </section>
        
        <!-- 특기사항 생성 조건 입력 -->
        <section class="interactive-section mb-8 p-6 bg-white rounded-2xl shadow-lg">
            <div class="flex items-center mb-4">
                <i class="fas fa-cogs text-violet-500 text-xl mr-3"></i>
                <h2 class="text-2xl font-bold">특기사항 생성 조건 입력</h2>
            </div>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="record-type" class="block text-sm font-medium text-slate-700">특기사항 종류</label>
                     <select id="record-type" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent">
                        <option value="교과세특">교과세특</option>
                        <option value="동아리활동">동아리활동</option>
                        <option value="자율활동">자율활동</option>
                        <option value="진로활동">진로활동</option>
                        <option value="행동발달특성">행동발달특성</option>
                    </select>
                </div>
                <div id="subject-wrapper">
                    <label for="subject" class="block text-sm font-medium text-slate-700">과목명</label>
                    <input type="text" id="subject" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent" value="국어">
                </div>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="guidelines" class="block text-sm font-medium text-slate-700">특기사항 입력 시 꼭 반영되어야 할 지침</label>
                    <textarea id="guidelines" rows="3" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent"></textarea>
                </div>
                <div>
                    <label for="start-phrase" class="block text-sm font-medium text-slate-700">특기사항 입력 시 시작 문구</label>
                    <input type="text" id="start-phrase" placeholder="예시: 문학작품 비평하기 활동을 통해~" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-transparent">
                </div>
            </div>
        </section>

        <!-- 파일 업로드 -->
        <section class="interactive-section mb-8 p-6 bg-white rounded-2xl shadow-lg">
             <div class="flex items-center mb-4">
                <i class="fas fa-upload text-indigo-500 text-xl mr-3"></i>
                <h2 class="text-2xl font-bold">파일 업로드 및 생성</h2>
            </div>
            <p class="text-slate-600 mb-6">자료 형태에 맞는 업로드 방식을 선택해주세요.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-center">
                <!-- 단일 파일 업로드 버튼 -->
                <button id="single-file-btn" class="p-6 border-2 border-dashed border-slate-300 rounded-lg hover:bg-slate-100 hover:border-indigo-400 transition-colors">
                    <div class="flex justify-center items-center mb-4">
                        <svg class="w-12 h-12 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    </div>
                    <h3 class="font-semibold text-lg">단일 파일 업로드</h3>
                    <p class="text-sm text-slate-500 mt-1">여러 활동 기록이 단일 파일(엑셀)에 정리된 경우</p>
                </button>
                
                <!-- 개별 파일 업로드 버튼 -->
                 <button id="individual-files-btn" class="p-6 border-2 border-dashed border-slate-300 rounded-lg hover:bg-slate-100 hover:border-violet-400 transition-colors">
                     <div class="flex justify-center items-center mb-4">
                        <svg class="w-12 h-12 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    </div>
                    <h3 class="font-semibold text-lg">개별 파일 업로드</h3>
                    <p class="text-sm text-slate-500 mt-1">학생 개별 활동 자료를 업로드하는 경우</p>
                </button>
            </div>

            <!-- 단일 파일(엑셀) 업로드 영역 -->
            <div id="single-file-upload-area" class="hidden mt-6 text-center">
                 <p class="text-slate-600 mb-4">엑셀 양식을 다운로드하여 내용을 채운 후 업로드해주세요.</p>
                 <div class="flex justify-center gap-4">
                    <button id="download-excel-template" class="bg-emerald-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-emerald-600 transition-colors">
                        <i class="fas fa-file-excel mr-2"></i>엑셀 양식 다운로드
                    </button>
                    <button id="upload-excel-btn" class="bg-sky-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-sky-600 transition-colors">
                        <i class="fas fa-file-upload mr-2"></i>엑셀 파일 업로드
                    </button>
                    <input type="file" id="excel-file-input" class="hidden" accept=".xlsx, .xls">
                </div>
            </div>

            <!-- 개별 파일 업로드 영역 -->
            <div id="individual-files-upload-area" class="hidden mt-6">
                <label for="file-input" class="block text-sm font-medium text-slate-700 mb-2">학생 활동 자료 (파일명: 학번 5자리, 예: 20501)</label>
                <input type="file" id="file-input" multiple class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
            </div>
        </section>

        <!-- 진행 상황 -->
        <section id="progress-section" class="hidden interactive-section mb-8 p-6 bg-white rounded-2xl shadow-lg">
            <h2 class="text-2xl font-bold mb-4">생성 진행 상황</h2>
            <div class="w-full bg-slate-200 rounded-full h-4 overflow-hidden">
                <div id="progress-bar" class="h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <p id="progress-text" class="text-center mt-2 text-slate-600"></p>
        </section>

        <!-- 생성 결과 -->
        <section id="result-section" class="hidden">
            <div class="p-6 bg-white rounded-2xl shadow-lg">
                 <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center">
                        <i class="fas fa-clipboard-check text-violet-500 text-xl mr-3"></i>
                        <h2 class="text-2xl font-bold">생성 결과</h2>
                    </div>
                    <button id="copy-results" class="bg-slate-700 text-white font-semibold py-2 px-4 rounded-md hover:bg-slate-800 transition-colors">
                        <i class="fas fa-copy mr-2"></i>결과 복사하기
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table id="result-table" class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider" style="width: 10%;">학번</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider" style="width: 15%;">평가 수준</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider" style="width: 60%;">특기사항 내용</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider" style="width: 15%;">작업</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-slate-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- 상세보기 모달 -->
        <div id="details-modal" class="hidden fixed z-50 inset-0 overflow-y-auto">
             <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                    <div class="absolute inset-0 bg-slate-800 opacity-75"></div>
                </div>
                <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-pink-100 sm:mx-0 sm:h-10 sm:w-10">
                                <i class="fas fa-search-plus text-pink-600"></i>
                            </div>
                            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                                <h3 class="text-lg leading-6 font-medium text-slate-900" id="modal-title">상세 분석 (학번: <span id="modal-student-id"></span>)</h3>
                                <div class="mt-4">
                                    <h4 class="font-semibold">AI 생성 근거</h4>
                                    <p id="modal-ai-reasoning" class="text-sm text-slate-600 mt-1 whitespace-pre-wrap"></p>
                                    <h4 class="font-semibold mt-4">참조한 원본 내용</h4>
                                    <div id="modal-original-content" class="mt-1 p-3 border rounded-md bg-slate-50 h-64 overflow-y-auto text-sm"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="button" id="close-modal" class="mt-3 w-full inline-flex justify-center rounded-md border border-slate-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-slate-700 hover:bg-slate-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                            닫기
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Element References
            const apiKeyInput = document.getElementById('api-key');
            const apiProviderSelect = document.getElementById('api-provider');
            const saveApiKeyBtn = document.getElementById('save-api-key');
            const apiStatus = document.getElementById('api-status');
            
            const recordTypeSelect = document.getElementById('record-type');
            const subjectWrapper = document.getElementById('subject-wrapper');

            const singleFileBtn = document.getElementById('single-file-btn');
            const individualFilesBtn = document.getElementById('individual-files-btn');
            const singleFileUploadArea = document.getElementById('single-file-upload-area');
            const individualFilesUploadArea = document.getElementById('individual-files-upload-area');
            
            const downloadExcelTemplateBtn = document.getElementById('download-excel-template');
            const uploadExcelBtn = document.getElementById('upload-excel-btn');
            const excelFileInput = document.getElementById('excel-file-input');
            const fileInput = document.getElementById('file-input');

            const progressSection = document.getElementById('progress-section');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const resultSection = document.getElementById('result-section');
            const resultTableBody = document.querySelector('#result-table tbody');
            const copyResultsBtn = document.getElementById('copy-results');

            const detailsModal = document.getElementById('details-modal');
            const closeModalBtn = document.getElementById('close-modal');
            
            const interactiveSections = document.querySelectorAll('.interactive-section');

            let studentData = {}; // { studentId: { content: '', originalContent: '', reasoning: '' } }
            
            // --- Initialization ---
            loadApiConfig();
            loadFormData();

            // --- Event Listeners ---
            saveApiKeyBtn.addEventListener('click', saveApiConfig);
            recordTypeSelect.addEventListener('change', toggleSubjectVisibility);
            
            // Animation for sections
            interactiveSections.forEach(section => {
                section.addEventListener('focusin', () => {
                    interactiveSections.forEach(s => s.classList.remove('animate-pop'));
                    section.classList.add('animate-pop');
                    section.addEventListener('animationend', () => {
                        section.classList.remove('animate-pop');
                    }, { once: true });
                });
            });


            // Upload type selection
            singleFileBtn.addEventListener('click', () => {
                singleFileUploadArea.classList.remove('hidden');
                individualFilesUploadArea.classList.add('hidden');
                singleFileBtn.classList.add('border-indigo-400', 'bg-indigo-50');
                individualFilesBtn.classList.remove('border-violet-400', 'bg-violet-50');
            });

            individualFilesBtn.addEventListener('click', () => {
                individualFilesUploadArea.classList.remove('hidden');
                singleFileUploadArea.classList.add('hidden');
                individualFilesBtn.classList.add('border-violet-400', 'bg-violet-50');
                singleFileBtn.classList.remove('border-indigo-400', 'bg-indigo-50');
            });
            
            // Excel actions
            downloadExcelTemplateBtn.addEventListener('click', downloadExcelTemplate);
            uploadExcelBtn.addEventListener('click', () => excelFileInput.click());
            excelFileInput.addEventListener('change', handleExcelUpload);

            // Individual files action
            fileInput.addEventListener('change', handleIndividualFilesUpload);

            // Save form data on input
            const inputsToSave = document.querySelectorAll('#curriculum-info, #class-activity-info, #record-type, #subject, #guidelines, #start-phrase');
            inputsToSave.forEach(input => {
                input.addEventListener('input', saveFormData);
            });

            copyResultsBtn.addEventListener('click', copyResultsToClipboard);
            closeModalBtn.addEventListener('click', () => detailsModal.classList.add('hidden'));

            // --- Functions ---
            function toggleSubjectVisibility() {
                if (recordTypeSelect.value === '교과세특') {
                    subjectWrapper.classList.remove('hidden');
                } else {
                    subjectWrapper.classList.add('hidden');
                }
            }
            
            function downloadExcelTemplate() {
                const worksheet = XLSX.utils.json_to_sheet([
                    { "학번": "20501", "이름": "김민준", "활동내용": "여기에 학생의 활동 내용을 상세히 입력하세요." },
                    { "학번": "20502", "이름": "이서아", "활동내용": "보고서, 탐구활동, 발표 등 구체적인 내용을 작성합니다." }
                ]);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "활동 기록");
                XLSX.writeFile(workbook, "특기사항_입력_양식.xlsx");
            }

            async function handleExcelUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const excelData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (!excelData.length || !excelData[0]['학번'] || !excelData[0]['활동내용']) {
                        alert('엑셀 파일의 헤더(첫 번째 행)에 "학번"과 "활동내용"이 포함되어 있는지 확인해주세요.');
                        return;
                    }
                    
                    await processData(excelData.map(row => ({
                        id: String(row['학번']).trim(),
                        content: String(row['활동내용']).trim()
                    })));
                };
                reader.readAsArrayBuffer(file);
            }
            
            async function handleIndividualFilesUpload(event) {
                const files = event.target.files;
                if (!files.length) return;

                const filePromises = Array.from(files).map(async file => {
                    const studentId = file.name.split('.')[0].trim();
                    const content = await readFileContent(file);
                    return { id: studentId, content: content.trim() };
                });
                
                const dataToProcess = await Promise.all(filePromises);
                await processData(dataToProcess);
            }

            async function processData(data) {
                if (!data.length) return;
                
                resetUI();
                progressSection.classList.remove('hidden');
                resultSection.classList.remove('hidden');

                let processedCount = 0;
                for (const item of data) {
                    const { id, content } = item;
                    studentData[id] = { content: '', originalContent: content, reasoning: '' };

                    try {
                        const resultText = await callGenerativeAPI(content, '중');
                        studentData[id].content = resultText;
                        addResultRow(id, resultText);
                    } catch (error) {
                        console.error(`Error processing for ${id}:`, error);
                        addErrorRow(id, error.message);
                    }

                    processedCount++;
                    updateProgress(processedCount, data.length);
                }
            }

            function resetUI() {
                resultTableBody.innerHTML = '';
                studentData = {};
                progressBar.style.width = '0%';
                progressText.textContent = '';
            }
            
            function updateProgress(current, total) {
                const percentage = Math.round((current / total) * 100);
                progressBar.style.width = `${percentage}%`;
                progressText.textContent = `${current} / ${total} 개 생성 완료`;
            }

            function addResultRow(studentId, content) {
                const row = document.createElement('tr');
                row.id = `row-${studentId}`;
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-slate-900">${studentId}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-500">
                        <select class="level-select p-1 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-violet-500" data-id="${studentId}">
                            <option value="상">상</option>
                            <option value="중상">중상</option>
                            <option value="중" selected>중</option>
                            <option value="중하">중하</option>
                            <option value="하">하</option>
                        </select>
                    </td>
                    <td class="px-4 py-3 text-sm text-slate-700 whitespace-pre-wrap">
                        <div class="content-display">${content}</div>
                        <textarea class="content-edit hidden w-full p-1 border rounded-md resize-none overflow-hidden"></textarea>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium align-middle">
                        <div class="flex items-center space-x-3">
                            <button class="edit-btn text-pink-500 hover:text-pink-700" data-id="${studentId}"><i class="fas fa-pencil-alt text-xl"></i></button>
                            <button class="save-btn text-emerald-500 hover:text-emerald-700 hidden" data-id="${studentId}"><i class="fas fa-check text-xl"></i></button>
                            <button class="details-btn text-violet-500 hover:text-violet-700" data-id="${studentId}"><i class="fas fa-search-plus text-xl"></i></button>
                        </div>
                    </td>
                `;
                resultTableBody.appendChild(row);

                const textarea = row.querySelector('.content-edit');
                textarea.addEventListener('input', () => {
                    textarea.style.height = 'auto';
                    textarea.style.height = `${textarea.scrollHeight}px`;
                });
                
                // Add event listeners for new row elements
                row.querySelector('.level-select').addEventListener('change', handleLevelChange);
                row.querySelector('.edit-btn').addEventListener('click', handleEditClick);
                row.querySelector('.save-btn').addEventListener('click', handleSaveClick);
                row.querySelector('.details-btn').addEventListener('click', handleDetailsClick);
            }
            
             function addErrorRow(studentId, errorMessage) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-red-600">${studentId}</td>
                    <td class="px-4 py-3 text-sm text-red-600" colspan="3">${errorMessage}</td>
                `;
                resultTableBody.appendChild(row);
            }
            
            async function handleLevelChange(event) {
                const studentId = event.target.dataset.id;
                const newLevel = event.target.value;
                const row = document.getElementById(`row-${studentId}`);
                const contentDisplay = row.querySelector('.content-display');

                contentDisplay.innerHTML = `<div class="flex justify-center items-center"><div class="spinner h-5 w-5 rounded-full border-4 border-slate-200"></div></div>`;

                try {
                    const newContent = await callGenerativeAPI(studentData[studentId].originalContent, newLevel);
                    studentData[studentId].content = newContent.trim();
                    contentDisplay.textContent = newContent.trim();
                    const textarea = row.querySelector('.content-edit');
                    textarea.value = newContent.trim();
                    textarea.style.height = 'auto';
                    textarea.style.height = `${textarea.scrollHeight}px`;
                } catch (error) {
                    console.error('Error regenerating content:', error);
                    contentDisplay.textContent = '내용을 다시 생성하는 중 오류가 발생했습니다.';
                    contentDisplay.classList.add('text-red-500');
                }
            }
            
            function handleEditClick(event) {
                const studentId = event.currentTarget.dataset.id;
                const row = document.getElementById(`row-${studentId}`);
                const display = row.querySelector('.content-display');
                const edit = row.querySelector('.content-edit');
                
                edit.value = display.textContent; // Ensure textarea has latest content
                display.classList.add('hidden');
                edit.classList.remove('hidden');
                row.querySelector('.edit-btn').classList.add('hidden');
                row.querySelector('.save-btn').classList.remove('hidden');
                
                edit.style.height = 'auto';
                edit.style.height = `${edit.scrollHeight}px`;
                edit.focus();
            }

            function handleSaveClick(event) {
                const studentId = event.currentTarget.dataset.id;
                const row = document.getElementById(`row-${studentId}`);
                const newContent = row.querySelector('.content-edit').value.trim();
                
                studentData[studentId].content = newContent;
                row.querySelector('.content-display').textContent = newContent;

                row.querySelector('.content-display').classList.remove('hidden');
                row.querySelector('.content-edit').classList.add('hidden');
                row.querySelector('.edit-btn').classList.remove('hidden');
                row.querySelector('.save-btn').classList.add('hidden');
            }
            
             async function handleDetailsClick(event) {
                const studentId = event.currentTarget.dataset.id;
                document.getElementById('modal-student-id').textContent = studentId;

                const aiReasoningEl = document.getElementById('modal-ai-reasoning');
                const originalContentEl = document.getElementById('modal-original-content');

                originalContentEl.textContent = studentData[studentId].originalContent;

                if (studentData[studentId].reasoning) {
                    aiReasoningEl.textContent = studentData[studentId].reasoning;
                } else {
                    aiReasoningEl.innerHTML = `<div class="flex justify-center items-center"><div class="spinner h-5 w-5 rounded-full border-4 border-slate-200"></div></div>`;
                    try {
                        const reasoningPrompt = `
                            아래의 '원본 학생 활동 내용'을 바탕으로 생성된 '특기사항 결과'가 어떤 근거로 작성되었는지 설명해주세요.
                            - 원본 내용의 어떤 구절이나 키워드를 참조했는지 구체적으로 언급해주세요.
                            - 분석적이고 전문적인 톤으로 설명해주세요.
                            
                            ---
                            [원본 학생 활동 내용]
                            ${studentData[studentId].originalContent}
                            
                            ---
                            [특기사항 결과]
                            ${studentData[studentId].content}
                            ---
                        `;
                        const reasoning = await callGenerativeAPI(reasoningPrompt, '중', true);
                        studentData[studentId].reasoning = reasoning;
                        aiReasoningEl.textContent = reasoning;
                    } catch (error) {
                        aiReasoningEl.textContent = '근거를 생성하는 중 오류가 발생했습니다.';
                        aiReasoningEl.classList.add('text-red-500');
                    }
                }
                
                detailsModal.classList.remove('hidden');
            }

            async function callGenerativeAPI(fileContent, level, isReasoning = false) {
                const apiKey = localStorage.getItem('apiKey');
                const apiProvider = localStorage.getItem('apiProvider') || 'openai';

                if (!apiKey) {
                    throw new Error("API 키가 설정되지 않았습니다. API 설정 섹션에서 키를 입력하고 저장해주세요.");
                }

                const prompt = isReasoning ? fileContent : buildPrompt(fileContent, level);
                let response;

                try {
                    if (apiProvider === 'openai') {
                        response = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify({
                                model: 'gpt-4o',
                                messages: [{ role: 'user', content: prompt }],
                                temperature: 0.7,
                            })
                        });
                    } else { // Gemini
                         response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }] }]
                            })
                        });
                    }

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API 요청 실패: ${errorData.error?.message || response.statusText}`);
                    }

                    const data = await response.json();
                    let resultText = '';

                    if (apiProvider === 'openai') {
                        resultText = data.choices[0]?.message?.content;
                    } else { // Gemini
                        resultText = data.candidates[0]?.content?.parts[0]?.text;
                    }
                    
                    return resultText ? resultText.trim() : '결과를 생성하지 못했습니다.';

                } catch (error) {
                    console.error("API Call Error:", error);
                    throw error;
                }
            }
            
            function buildPrompt(fileContent, level) {
                const recordType = document.getElementById('record-type').value;
                const subject = document.getElementById('subject').value;
                const curriculumInfo = document.getElementById('curriculum-info').value;
                const classActivityInfo = document.getElementById('class-activity-info').value;
                const guidelines = document.getElementById('guidelines').value;
                let startPhrase = document.getElementById('start-phrase').value.trim();

                const recordDefinitions = {
                    '교과세특': '학생참여형 수업 및 수업과 연계된 수행평가 등에서 관찰한 내용을 입력함.',
                    '자율활동': '임원 활동, 학교 행사 참여, 학교 프로그램 이수 등 학교생활 충실도를 평가합니다.',
                    '동아리활동': '자율동아리는 반영되지 않으며, 정규 창체 동아리에서의 활동 내용, 역할, 고민 등을 구체적으로 기록합니다.',
                    '진로활동': '희망 분야 관련 보고서, 직업 체험, 전문가 초청 프로그램 참여 경험 등을 기록하며, 학습 내용을 현재 관심사와 연결하려는 노력이 중요합니다.',
                    '행동발달특성': '학생의 전반적인 인성, 자기주도성, 학교생활에서의 태도 변화, 성장 과정 등을 종합적으로 평가하여 기록합니다.'
                };
                const recordDefinition = recordDefinitions[recordType];
                
                let levelInstruction = '';
                switch (level) {
                    case '상':
                    case '중상':
                        levelInstruction = '학생의 역량과 활동의 우수성이 잘 드러나 보도록 매우 구체적인 사례와 함께 깊이 있게 서술해주세요. 분량은 400자에서 500자 내외로 작성해주세요.';
                        break;
                    case '중':
                        levelInstruction = '활동에 대한 사실을 객관적으로 기록하고, 그에 대한 사실적인 평가가 드러나도록 서술해주세요. 분량은 200자에서 300자 내외로 작성해주세요.';
                        break;
                    case '하':
                    case '중하':
                        levelInstruction = '활동에 참여했다는 사실을 중심으로 단순하고 간결하게 기록해주세요. 분량은 100자에서 200자 내외로 작성해주세요.';
                        break;
                }

                return `
                    # 지시사항: 학생 활동 기록문을 바탕으로 지정된 조건에 맞춰 특기사항을 작성해주세요.

                    ## 1. 작성 맥락
                    - 특기사항 종류: ${recordType}
                    - 영역 정의: ${recordDefinition}
                    ${recordType === '교과세특' ? `- 과목: ${subject}` : ''}
                    - 관련 교육과정: ${curriculumInfo || '미지정'}
                    - 수업(활동) 내용: ${classActivityInfo || '미지정'}

                    ## 2. 생성 조건
                    - 학생 수행 수준: ${level} (${levelInstruction})
                    - 사용자 추가 지침: ${guidelines || '없음'}

                    ## 3. 출력 형식 및 스타일 가이드
                    - **시작 문구:** "${startPhrase}" (만약 시작 문구가 있다면 반드시 이 문구로 시작해주세요. 없다면 자율적으로 시작해주세요.)
                    - **결과물 형식:** 최종 결과물에는 수행 수준('상', '중', '하' 등), 넘버링, 제목, 구분선 등 어떤 부가 정보도 포함하지 마세요. 오직 특기사항 내용 본문만 출력해야 합니다.
                    - **어조 및 문체:** 품격 있고 신뢰감을 주는 전문가적 어조를 사용하세요.
                    - **문장 종결 어미:** 모든 문장은 '~임.', '~음.', '~함.'으로 끝내주세요.
                    - **금지 단어:** '학생', '그는', '그가', '그의'와 같은 3인칭 대명사를 사용하지 마세요.
                    - **긍정적 서술:** 제출된 활동 내용에서 긍정적인 역량을 부각하여 구체적으로 서술해주세요.
                    - **부정적 서술 변환:** 만약 부정적인 키워드가 있다면, 그대로 사용하지 말고 긍정적 성장 가능성으로 변환하여 서술해주세요. (예: '인내심 부족' -> '꾸준한 자기 성찰을 통해 더 많은 여유를 갖춘다면 크게 성장할 것으로 기대됨.')
                    - **언어:** 모든 영어는 한국어로 번역해주세요.
                    - **줄바꿈:** 문단 전체는 줄바꿈 없이 한 줄로 이어지게 작성해주세요.

                    ## 4. 참고 예시 및 키워드
                    - **예시1:** 문학작품 감상 기반 통합적 적용 탐구활동으로 도파민 추구 현상에 관심을 갖고 '트렌드 코리아 2024(김난도 외)'에서 관련 부분을 찾아 읽고 도파민 추구 현상을 적절하게 활용한다면 지루하다고 여기는 과업들을 수행할 때 더 큰 성취감과 보상, 흥미를 느낄 수 있다는 가설을 세우고 보고서를 작성함.
                    - **예시2:** '동물실험은 허용되어야 한다'라는 논제로 진행된 토론에서 찬성측 입장으로서 우수한 논리력과 설득력을 발휘함. 주제에 대한 깊이 있는 이해와 철저한 준비가 돋보였으며, 토론의 핵심 쟁점을 명확히 파악하고 논리적으로 정리함.
                    - **활용 가능 키워드:** 탐구함, 성찰함, 능숙함, 생각이 깊음, 분석적 사고력, 자신있게 이야기함, 뛰어남, 탁월함, 발휘함, 인상적임, 분석함, 확장함, 추론함, 토론함, 우수함, 돋보임, 발표함, 설명함, 이끌어냄, 제시함, 다양한 배경지식, 논리적, 창의적, 비판적 사고, 인문학적 성찰, 논리정연.

                    ---
                    ## 5. 학생 활동 기록문 (이 내용을 바탕으로 작성):
                    ${fileContent}
                `;
            }

            async function readFileContent(file) {
                const extension = file.name.split('.').pop().toLowerCase();
                return new Promise((resolve, reject) => {
                    if (extension === 'txt') {
                        const reader = new FileReader();
                        reader.onload = e => resolve(e.target.result);
                        reader.onerror = reject;
                        reader.readAsText(file);
                    } else if (extension === 'pdf') {
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            try {
                                const pdf = await pdfjsLib.getDocument({ data: e.target.result }).promise;
                                let text = '';
                                for (let i = 1; i <= pdf.numPages; i++) {
                                    const page = await pdf.getPage(i);
                                    const content = await page.getTextContent();
                                    text += content.items.map(item => item.str).join(' ');
                                }
                                resolve(text);
                            } catch (error) {
                                reject(error);
                            }
                        };
                        reader.onerror = reject;
                        reader.readAsArrayBuffer(file);
                    } else if (extension === 'docx') {
                         const reader = new FileReader();
                         reader.onload = (e) => {
                            docx.renderAsync(e.target.result, document.createElement('div'))
                                .then(x => {
                                    resolve(x.innerText || '');
                                })
                                .catch(reject);
                         };
                         reader.onerror = reject;
                         reader.readAsArrayBuffer(file);
                    } else {
                        resolve(`지원하지 않는 파일 형식입니다: .${extension}`);
                    }
                });
            }

            function copyResultsToClipboard() {
                let textToCopy = '';
                const rows = resultTableBody.querySelectorAll('tr');
                rows.forEach(row => {
                    const studentId = row.cells[0].textContent;
                    const content = studentData[studentId]?.content || row.querySelector('.content-display').textContent;
                    textToCopy += `${studentId}\t${content}\n`;
                });

                const textarea = document.createElement('textarea');
                textarea.value = textToCopy;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    alert('결과가 클립보드에 복사되었습니다.');
                } catch (err) {
                    alert('클립보드 복사에 실패했습니다.');
                }
                document.body.removeChild(textarea);
            }

            function saveApiConfig() {
                const key = apiKeyInput.value;
                const provider = apiProviderSelect.value;
                if (key) {
                    localStorage.setItem('apiKey', key);
                    localStorage.setItem('apiProvider', provider);
                    apiStatus.textContent = `${provider.toUpperCase()} API 키가 브라우저에 저장되었습니다.`;
                    setTimeout(() => apiStatus.textContent = '', 3000);
                } else {
                    apiStatus.textContent = 'API 키를 입력해주세요.';
                    apiStatus.classList.remove('text-green-600');
                    apiStatus.classList.add('text-red-600');
                }
            }

            function loadApiConfig() {
                const savedKey = localStorage.getItem('apiKey');
                const savedProvider = localStorage.getItem('apiProvider');
                if (savedKey) apiKeyInput.value = savedKey;
                if (savedProvider) apiProviderSelect.value = savedProvider;
            }
            
            function saveFormData() {
                const formData = {
                    curriculumInfo: document.getElementById('curriculum-info').value,
                    classActivityInfo: document.getElementById('class-activity-info').value,
                    recordType: document.getElementById('record-type').value,
                    subject: document.getElementById('subject').value,
                    guidelines: document.getElementById('guidelines').value,
                    startPhrase: document.getElementById('start-phrase').value,
                };
                localStorage.setItem('formData', JSON.stringify(formData));
            }

            function loadFormData() {
                const savedData = localStorage.getItem('formData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    document.getElementById('curriculum-info').value = data.curriculumInfo || '';
                    document.getElementById('class-activity-info').value = data.classActivityInfo || '';
                    document.getElementById('record-type').value = data.recordType || '교과세특';
                    document.getElementById('subject').value = data.subject || '국어';
                    document.getElementById('guidelines').value = data.guidelines || '';
                    document.getElementById('start-phrase').value = data.startPhrase || '';
                }
                toggleSubjectVisibility(); // Initial check
            }
        });
    </script>
</body>
</html>



