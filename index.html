<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학생 활동 기반 교과세특 생성기 (v3.0)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- PDF & DOCX 파일 처리를 위한 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.18/mammoth.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .gradient-text {
            background: linear-gradient(90deg, #4f46e5, #ec4899, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient-flow 5s ease infinite;
            background-size: 200% 200%;
        }
        @keyframes gradient-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .icon-wrapper { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .icon-wrapper i { width: 48px; height: 48px; margin-bottom: 8px; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 24px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .details-reference { border-left: 3px solid #6366f1; padding-left: 1rem; margin-bottom: 1rem; font-style: italic; color: #4b5563; }
        .regenerating-cell {
            color: #9ca3af;
            font-style: italic;
            text-align: center;
        }
        .evaluation-select {
            /* background-image: linear-gradient(to right, #e0e7ff, #fbcfe8); */ /* pastel blue to pastel pink */
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        
        <header class="text-center mb-12 py-8">
            <h1 class="text-4xl md:text-5xl font-bold gradient-text mb-4 leading-snug md:leading-snug">학생 활동 기반 교과세특 생성기</h1>
            <p class="text-lg text-gray-600">학생들의 활동 보고서를 기반으로 AI가 맞춤형 교과세특 초안을 생성합니다.</p>
        </header>

        <section class="mb-12 p-6 bg-white rounded-xl shadow-md">
            <h2 class="text-2xl font-bold mb-6 text-center text-indigo-600 flex items-center justify-center"><i data-lucide="book-open-check" class="mr-2"></i>사용 방법 안내</h2>
            <div class="grid md:grid-cols-3 gap-8">
                <div class="icon-wrapper"><i data-lucide="settings-2" class="text-pink-500"></i><h3 class="font-bold text-lg mb-2">1. 환경 설정</h3><p class="text-sm text-gray-600">API 키를 입력/저장하고, 공통 수업 맥락을 설정합니다.</p></div>
                <div class="icon-wrapper"><i data-lucide="upload-cloud" class="text-orange-500"></i><h3 class="font-bold text-lg mb-2">2. 파일 업로드</h3><p class="text-sm text-gray-600">'학번 5자리' 이름의 파일을 올리면 '중' 수준으로 결과가 생성됩니다.</p></div>
                <div class="icon-wrapper"><i data-lucide="file-spreadsheet" class="text-indigo-500"></i><h3 class="font-bold text-lg mb-2">3. 수준 조절 및 활용</h3><p class="text-sm text-gray-600">학생별 평가 수준을 조절하여 내용을 재구성하고 복사합니다.</p></div>
            </div>
        </section>

        <section class="mb-8 p-6 bg-white rounded-xl shadow-md">
            <h2 class="text-2xl font-bold mb-6 text-center text-indigo-600 flex items-center justify-center"><i data-lucide="key-round" class="mr-2"></i>API 설정</h2>
            <div class="space-y-4">
                <div>
                    <label for="api-provider" class="block text-sm font-medium text-gray-700">API 선택</label>
                    <select id="api-provider" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <option value="openai">OpenAI</option>
                        <option value="gemini">Google Gemini</option>
                    </select>
                </div>
                <div>
                    <label for="api-key" class="block text-sm font-medium text-gray-700">API 키</label>
                    <input type="password" id="api-key" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="사용할 API 키를 입력하세요">
                </div>
                <div class="text-right">
                    <button id="save-api-key" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">설정 저장</button>
                </div>
            </div>
        </section>

        <section class="mb-8 p-6 bg-white rounded-xl shadow-md">
            <h2 class="text-2xl font-bold mb-6 text-center text-indigo-600 flex items-center justify-center"><i data-lucide="book-marked" class="mr-2"></i>교육과정-수업 맥락 설정</h2>
            <div class="space-y-4">
                <div>
                    <label for="curriculum-info" class="block text-sm font-medium text-gray-700">관련 교육과정 성취기준 / 단원명 / 학습주제</label>
                    <input type="text" id="curriculum-info" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="예: [10국02-01] 읽기의 과정을 점검하고 조정하며 글을 읽는다.">
                </div>
                <div>
                    <label for="class-activity-info" class="block text-sm font-medium text-gray-700">수업(활동) 내용 소개</label>
                    <textarea id="class-activity-info" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="어떤 수업이나 활동이었는지 구체적으로 소개해 주세요."></textarea>
                </div>
            </div>
        </section>

        <section class="mb-8 p-6 bg-white rounded-xl shadow-md">
            <h2 class="text-2xl font-bold mb-6 text-center text-indigo-600 flex items-center justify-center"><i data-lucide="edit-3" class="mr-2"></i>교과세특 생성 조건 입력</h2>
            <form id="settings-form" class="space-y-4">
                 <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label for="subject" class="block text-sm font-medium text-gray-700">과목명</label>
                        <input type="text" id="subject" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" value="국어">
                    </div>
                    <div>
                        <label for="grade" class="block text-sm font-medium text-gray-700">학년</label>
                        <input type="text" id="grade" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" value="2학년">
                    </div>
                </div>
                <div>
                    <label for="guidelines" class="block text-sm font-medium text-gray-700">교과세특 입력 시 꼭 반영되어야 할 지침</label>
                    <textarea id="guidelines" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="예: 학생의 성장 과정이 잘 드러나도록 작성할 것."></textarea>
                </div>
                <div>
                    <label for="start-phrase" class="block text-sm font-medium text-gray-700">교과세특 입력 시 시작 문구</label>
                    <input type="text" id="start-phrase" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="예: 문학작품 비평하기 활동을 통해~">
                </div>
            </form>
        </section>

        <section class="text-center">
            <button id="upload-button" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                <i data-lucide="file-up" class="inline-block mr-2 -mt-1"></i>파일 업로드 및 세특 생성
            </button>
            <input type="file" id="file-input" multiple class="hidden" accept=".txt,.pdf,.docx">
        </section>

        <section id="results-section" class="mt-12 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-indigo-600"><i data-lucide="check-circle" class="inline-block mr-2 -mt-1"></i>생성 결과</h2>
                <button id="copy-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    <i data-lucide="copy" class="inline-block mr-2 -mt-1 h-4 w-4"></i>결과 복사하기
                </button>
            </div>
            <div class="overflow-x-auto bg-white rounded-xl shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">학번</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">평가 수준</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">교과세특 내용</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">작업</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- 모달 창들 -->
    <div id="modal" class="modal"><div class="modal-content"><div id="loader-container" class="text-center"><div class="loader mx-auto"></div><p id="loader-text" class="mt-4 text-lg font-semibold text-gray-700">교과세특을 생성 중입니다... (0/0)</p><p class="mt-2 text-sm text-gray-500">잠시만 기다려 주세요.</p></div><div id="alert-container" class="hidden text-center"><h3 id="alert-title" class="text-xl font-bold text-red-600 mb-2"></h3><p id="alert-message" class="text-gray-700"></p><button id="close-modal-button" class="mt-6 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg">확인</button></div></div></div>
    <div id="details-modal" class="modal"><div class="modal-content max-w-2xl"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-indigo-600">AI 참조 원본 내용</h3><button id="close-details-modal-button" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button></div><div id="details-content" class="text-sm text-gray-700 bg-gray-100 p-4 rounded-lg max-h-96 overflow-y-auto"></div></div></div>

    <script>
        lucide.createIcons();
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;

        const uploadButton = document.getElementById('upload-button');
        const fileInput = document.getElementById('file-input');
        const resultsSection = document.getElementById('results-section');
        const resultsTableBody = document.getElementById('results-table-body');
        const copyButton = document.getElementById('copy-button');
        const modal = document.getElementById('modal');
        const loaderContainer = document.getElementById('loader-container');
        const loaderText = document.getElementById('loader-text');
        const alertContainer = document.getElementById('alert-container');
        const alertTitle = document.getElementById('alert-title');
        const alertMessage = document.getElementById('alert-message');
        const closeModalButton = document.getElementById('close-modal-button');
        const apiKeyInput = document.getElementById('api-key');
        const apiProviderSelect = document.getElementById('api-provider');
        const saveApiKeyButton = document.getElementById('save-api-key');
        const detailsModal = document.getElementById('details-modal');
        const detailsContent = document.getElementById('details-content');
        const closeDetailsModalButton = document.getElementById('close-details-modal-button');

        uploadButton.addEventListener('click', () => fileInput.click());
        closeModalButton.addEventListener('click', () => modal.style.display = 'none');
        closeDetailsModalButton.addEventListener('click', () => detailsModal.style.display = 'none');
        window.addEventListener('click', (event) => {
            if (event.target == modal) modal.style.display = 'none';
            if (event.target == detailsModal) detailsModal.style.display = 'none';
        });

        saveApiKeyButton.addEventListener('click', () => {
            localStorage.setItem('apiKey', apiKeyInput.value);
            localStorage.setItem('apiProvider', apiProviderSelect.value);
            showModalAlert('저장 완료', 'API 설정이 로컬 브라우저에 저장되었습니다.');
        });

        document.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('apiKey');
            const savedProvider = localStorage.getItem('apiProvider');
            if (savedKey) apiKeyInput.value = savedKey;
            if (savedProvider) apiProviderSelect.value = savedProvider;

            loadFormData();

            const inputsToSave = document.querySelectorAll('#curriculum-info, #class-activity-info, #subject, #grade, #guidelines, #start-phrase');
            inputsToSave.forEach(input => {
                input.addEventListener('input', saveFormData);
            });
        });

        function saveFormData() {
            const formData = {
                curriculumInfo: document.getElementById('curriculum-info').value,
                classActivityInfo: document.getElementById('class-activity-info').value,
                subject: document.getElementById('subject').value,
                grade: document.getElementById('grade').value,
                guidelines: document.getElementById('guidelines').value,
                startPhrase: document.getElementById('start-phrase').value,
            };
            localStorage.setItem('formData', JSON.stringify(formData));
        }

        function loadFormData() {
            const savedData = localStorage.getItem('formData');
            if (savedData) {
                const data = JSON.parse(savedData);
                document.getElementById('curriculum-info').value = data.curriculumInfo || '';
                document.getElementById('class-activity-info').value = data.classActivityInfo || '';
                document.getElementById('subject').value = data.subject || '국어';
                document.getElementById('grade').value = data.grade || '2학년';
                document.getElementById('guidelines').value = data.guidelines || '';
                document.getElementById('start-phrase').value = data.startPhrase || '';
            }
        }

        fileInput.addEventListener('change', async (event) => {
            const files = event.target.files;
            if (files.length === 0) return;

            const validFiles = [], invalidFormatFiles = [], invalidNameFiles = [];
            const allowedExtensions = ['txt', 'pdf', 'docx'];

            for (const file of files) {
                const fileName = file.name.split('.')[0];
                const fileExtension = file.name.split('.').pop().toLowerCase();
                if (!allowedExtensions.includes(fileExtension)) invalidFormatFiles.push(file.name);
                else if (!/^\d{5}$/.test(fileName)) invalidNameFiles.push(file.name);
                else validFiles.push(file);
            }

            if (invalidFormatFiles.length > 0) return showModalAlert('잘못된 파일 형식', `지원되는 파일 형식은 .txt, .pdf, .docx 입니다. (잘못된 파일: ${invalidFormatFiles.join(', ')})`);
            if (invalidNameFiles.length > 0) return showModalAlert('잘못된 파일명', `파일명을 '학번 5자리' 형식으로 지정해주세요. (잘못된 파일: ${invalidNameFiles.join(', ')})`);
            if (validFiles.length > 0) await processFiles(validFiles);
        });
        
        function showModalAlert(title, message) {
            loaderContainer.classList.add('hidden');
            alertContainer.classList.remove('hidden');
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            modal.style.display = 'flex';
        }
        
        async function readFileContent(file) {
            const extension = file.name.split('.').pop().toLowerCase();
            if (extension === 'txt') return await file.text();
            if (extension === 'pdf') {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let text = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(item => item.str).join(' ') + '\n';
                }
                return text;
            }
            if (extension === 'docx') {
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({ arrayBuffer });
                return result.value;
            }
            throw new Error(`지원되지 않는 파일 형식: .${extension}`);
        }

        async function processFiles(files) {
            alertContainer.classList.add('hidden');
            loaderContainer.classList.remove('hidden');
            loaderText.textContent = `교과세특을 생성 중입니다... (0/${files.length})`;
            modal.style.display = 'flex';
            resultsTableBody.innerHTML = '';
            resultsSection.classList.add('hidden');

            let results = [];
            let completedCount = 0;
            const initialEvaluationLevel = '중';

            for (const file of files) {
                let fileContent = '';
                try {
                    const studentId = file.name.split('.')[0];
                    loaderText.textContent = `[${studentId}] 파일 읽는 중...`;
                    fileContent = await readFileContent(file);
                    
                    loaderText.textContent = `[${studentId}] AI 생성 요청 중 ('${initialEvaluationLevel}' 수준)...`;
                    const prompt = buildPrompt(fileContent, initialEvaluationLevel);
                    const generatedResult = await callGenerativeAPI(prompt);

                    const parsedResponse = JSON.parse(generatedResult);
                    if (parsedResponse.report) {
                        parsedResponse.report = parsedResponse.report.trim();
                    }
                    results.push({ studentId, fileContent, jsonResponse: parsedResponse });

                } catch (error) {
                    console.error('Error processing file:', file.name, error);
                    results.push({ studentId: file.name.split('.')[0], fileContent, jsonResponse: { report: `오류 발생: ${error.message}`, references: [] } });
                } finally {
                    completedCount++;
                    loaderText.textContent = `교과세특을 생성 중입니다... (${completedCount}/${files.length})`;
                    if (completedCount < files.length) await new Promise(res => setTimeout(res, 1000));
                }
            }

            results.sort((a, b) => a.studentId.localeCompare(b.studentId));
            displayResults(results);
            modal.style.display = 'none';
        }
        
        async function callGenerativeAPI(prompt) {
            const provider = apiProviderSelect.value;
            const apiKey = apiKeyInput.value;
            if (!apiKey) throw new Error('API 키를 입력하고 저장해주세요.');

            if (provider === 'openai') {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: "gpt-4o", messages: [{ role: "user", content: prompt }], temperature: 0.7, max_tokens: 1500, response_format: { type: "json_object" } })
                });
                if (!response.ok) { const err = await response.json(); throw new Error(`OpenAI API 오류: ${err.error.message}`); }
                const result = await response.json();
                return result.choices[0].message.content.trim();
            } else if (provider === 'gemini') {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) { const err = await response.json(); throw new Error(`Gemini API 오류: ${err.error.message}`); }
                const result = await response.json();
                let jsonString = result.candidates[0].content.parts[0].text;
                jsonString = jsonString.replace(/```json/g, '').replace(/```/g, '').trim();
                return jsonString;
            }
        }
        
        function buildPrompt(studentActivity, evaluationLevel) {
            const subject = document.getElementById('subject').value;
            const grade = document.getElementById('grade').value;
            const guidelines = document.getElementById('guidelines').value;
            const startPhrase = document.getElementById('start-phrase').value.trim();
            const curriculumInfo = document.getElementById('curriculum-info').value;
            const classActivityInfo = document.getElementById('class-activity-info').value;

            return `
# 교과세특 작성 요청
당신은 학생들의 활동 내용을 바탕으로 개인 맞춤형 교과세특을 작성하는 AI 전문가입니다. 아래의 모든 지시사항을 **반드시** 준수하여 결과물을 생성해주세요.

## 1. 기본 정보 및 맥락
- **과목:** ${subject}
- **학년:** ${grade}
- **관련 성취기준/단원:** ${curriculumInfo || "지정되지 않음"}
- **수업(활동) 내용:** ${classActivityInfo || "지정되지 않음"}
- **교사 관찰 기반 학생 평가 수준:** ${evaluationLevel}

## 2. 작성 지침
- **평가 수준별 작성:** 제출된 학생 활동 내용과 교사가 선택한 학생의 수행 수준인 '**${evaluationLevel}**'에 맞춰 내용의 깊이, 구체성, 분량을 **명확히 차별화**하여 작성해야 합니다.
    - **'상' 수준:** 활동 내용에 대한 **구체적이고 심층적인 기록**과 함께, 학생의 **뛰어난 역량과 성취가 드러나는 우수한 평가**를 포함하여 작성합니다. 학생의 사고 과정, 독창적인 아이디어, 문제 해결 능력 등을 부각시켜 주세요. (권장 분량: 400자 ~ 500자)
    - **'중상' 수준:** 활동 내용에 대한 **구체적인 사실적 기록**을 바탕으로, 학생의 **성실한 참여와 긍정적인 변화**를 보여주는 평가를 포함하여 작성합니다. (권장 분량: 300자 ~ 400자)
    - **'중' 수준:** 활동 내용에 대한 **객관적이고 사실적인 기록**을 중심으로, 학생이 무엇을 했는지 명확히 드러나도록 작성합니다. (분량: 200자 ~ 300자)
    - **'중하' 수준:** 활동 내용에 대한 **단순하고 사실적인 기록**을 간결하게 작성합니다. (분량: 150자 ~ 200자)
    - **'하' 수준:** 활동에 **참여한 사실**을 중심으로 매우 간결하게 기록합니다. (분량: 100자 ~ 150자)
- **결과물 형식:** 결과물에는 '상', '중', '하'와 같은 수행 수준을 **절대로 명시하지 말고**, 바로 교과세특 내용만 시작되도록 해줘. 넘버링이나 다른 구분자도 넣지 말아줘.
- **금지 단어:** '학생', '그는', '그가', '그의'와 같은 3인칭 대명사는 절대 사용하지 마세요.
- **문체 및 어미:** 품격 있고 신뢰감 있는 전문가적 말투를 사용하고, 모든 문장의 어미를 '~임', '~음', '~함'으로 통일해주세요.
- **시작 문구:** 교과세특 내용은 반드시 다음 문구로 시작해주세요: "${startPhrase}" (만약 시작 문구가 비어있다면, 자율적으로 가장 적절한 문장으로 시작해주세요.)
- **긍정적 키워드:** 아래 제공된 [키워드] 목록을 참고하여, 긍정적인 역량을 구체적으로 부각시켜 주세요.
- **부정적 내용 변환:** 만약 원본 자료에 부정적 키워드가 있다면, 그대로 사용하지 마세요. 부정적인 면을 어떻게 극복할 수 있을지, 또는 극복 시 어떻게 성장할 수 있을지에 대한 내용으로 변환해주세요.
    - 예시) '인내심이 부족한' → '꾸준한 자기 성찰을 통해 더 많은 여유를 갖춘다면'
    - 예시) '신경질적' → '자신의 감정을 적절히 조절하고 책임감을 갖는다면'
    - 예시) '우유부단한' → '꾸준하게 자신감을 키워나가며 점차 결단력 있는 모습을 보임'
- **기타:** 영어는 한국어로 번역하고, 줄바꿈 없이 한 문단으로 작성해주세요.

## 3. 작성 예시 (참고용)
### 예시1 (상 수준)
문학작품 감상 기반 통합적 적용 탐구활동으로 도파민 추구 현상에 관심을 갖고 '트렌드 코리아 2024(김난도 외)'에서 관련 부분을 찾아 읽고 도파민 추구 현상을 적절하게 활용한다면 지루하다고 여기는 과업들을 수행할 때 더 큰 성취감과 보상, 흥미를 느낄 수 있다는 가설을 세우고 보고서를 작성함. 더 나아가 다양한 참고자료들을 탐구하여 도파민 추구현상을 교육분야에 활용할 수 있는 방안들을 제시함. 수업 시간에 '주산과 컴퓨터의 보수'를 주제로 한 텍스트를 학습한 후, 주판이 발달한 각 나라의 역사적 배경과 문화적 맥락을 탐구하며, 주판이 경제, 교육, 사회 등 다양한 분야에서 어떻게 활용되었는지를 체계적으로 탐구함. 특히, 주판이 현대에 이르기까지 끼친 영향을 분석하여, 계산 도구를 넘어 사회적, 문화적 유산으로 자리 잡은 과정을 이해함. 자기주도적 학습 능력과 탐구 정신이 뛰어나며, 역사적 맥락에서 주제를 깊이 있게 탐구하는 성숙한 태도가 돋보임.
### 예시2 (중 수준)
문학작품 창작과 비평하기 활동으로 '동물실험은 허용되어야 한다'라는 논제로 진행된 토론에서 찬성측 입장을 맡아 자신의 주장을 펼침. 토론의 핵심 쟁점을 파악하고 관련 자료를 찾아 정리하며 토론에 참여함. '호르몬 불균형' 관련 강연을 시청한 후, 멜라토닌 호르몬과 스트레스의 관계에 대해 추가 자료를 수집하고 분석하여 정리함.

## 4. 참고 키워드
탐구함. 성찰함. 능숙함. 생각이 깊음. 분석적 사고력이 뛰어남. 자신있게 이야기함. 뛰어남. 탁월함. 발휘함. 인상적임. 분석함. 확장함. 추론함. 토론함. 우수함. 충분함. 돋보임. 발표함. 설명함. 이끌어냄. 도모함. 제시함. 다양한 분야의 배경지식. 추측, 추론. 논리적이고 분석하는 능력. 창의적 발상. 비판적 사고력. 분석적 사고. 인문학적 성찰. 논리정연. 폭넓게 해석.

## 5. 학생 활동 원본 자료
---
${studentActivity}
---

## 6. 최종 결과물 형식 (매우 중요)
위의 모든 지침과 원본 자료를 바탕으로, 최종 결과물을 **반드시** 아래의 JSON 형식으로만 응답해주세요. JSON 외의 다른 설명이나 텍스트를 절대 추가하지 마세요.

\`\`\`json
{
  "report": "생성된 교과세특 내용 전체를 여기에 작성합니다.",
  "references": [
    "교과세특 내용의 첫 번째 핵심 근거가 된 원본 자료의 문장이나 구절을 그대로 여기에 복사합니다.",
    "두 번째 핵심 근거가 된 원본 자료의 다른 부분을 여기에 복사합니다.",
    "이런 식으로, 작성 내용의 핵심 근거가 된 원본 자료의 구절을 3~5개 항목으로 배열에 추가합니다."
  ]
}
\`\`\`
`;
        }
        
        function displayResults(results) {
            resultsTableBody.innerHTML = '';
            results.forEach(result => {
                const row = document.createElement('tr');
                // 원본 파일 내용을 포함하여 데이터셋에 저장
                row.dataset.result = JSON.stringify({
                    studentId: result.studentId,
                    fileContent: result.fileContent,
                    jsonResponse: result.jsonResponse
                });

                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${result.studentId}</td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <select class="evaluation-select block w-full p-2 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" data-studentid="${result.studentId}">
                            <option value="상">상</option>
                            <option value="중상">중상</option>
                            <option value="중" selected>중</option>
                            <option value="중하">중하</option>
                            <option value="하">하</option>
                        </select>
                    </td>
                    <td class="px-6 py-4 whitespace-pre-wrap text-sm text-gray-700 report-cell">
                        <span class="report-text">${result.jsonResponse.report}</span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="edit-btn text-indigo-600 hover:text-indigo-900 mr-2" title="수정"><i data-lucide="file-pen-line" class="pointer-events-none"></i></button>
                        <button class="details-btn text-green-600 hover:text-green-900" title="상세보기"><i data-lucide="search" class="pointer-events-none"></i></button>
                    </td>
                `;
                resultsTableBody.appendChild(row);
            });
            resultsSection.classList.remove('hidden');
            lucide.createIcons();
        }

        resultsTableBody.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            
            const row = target.closest('tr');
            const reportCell = row.querySelector('.report-cell');
            const reportSpan = reportCell.querySelector('.report-text');

            if (target.classList.contains('edit-btn')) {
                if (target.innerHTML.includes('file-pen-line')) { // 수정 시작
                    const currentText = reportSpan.textContent;
                    reportCell.innerHTML = `<textarea class="w-full h-40 p-2 border rounded-md">${currentText}</textarea>`;
                    target.innerHTML = `<i data-lucide="save" class="pointer-events-none"></i>`;
                    target.title = '저장';
                } else { // 수정 완료 (저장)
                    const newText = reportCell.querySelector('textarea').value;
                    reportCell.innerHTML = `<span class="report-text">${newText}</span>`;
                    target.innerHTML = `<i data-lucide="file-pen-line" class="pointer-events-none"></i>`;
                    target.title = '수정';
                    let resultData = JSON.parse(row.dataset.result);
                    resultData.jsonResponse.report = newText;
                    row.dataset.result = JSON.stringify(resultData);
                }
                lucide.createIcons();
            }

            if (target.classList.contains('details-btn')) {
                const result = JSON.parse(row.dataset.result);
                const references = result.jsonResponse.references || [];
                if (references.length > 0) {
                    detailsContent.innerHTML = references.map(ref => `<p class="details-reference">"${ref}"</p>`).join('');
                } else {
                    detailsContent.innerHTML = `<p class="text-gray-500">참조된 원본 내용이 없습니다.</p>`;
                }
                detailsModal.style.display = 'flex';
            }
        });

        resultsTableBody.addEventListener('change', async (e) => {
            if (e.target.classList.contains('evaluation-select')) {
                const selectElement = e.target;
                const newLevel = selectElement.value;
                const row = selectElement.closest('tr');
                const reportCell = row.querySelector('.report-cell');
                
                try {
                    reportCell.innerHTML = `<p class="regenerating-cell">'${newLevel}' 수준으로 재작성 중...</p>`;
                    selectElement.disabled = true;

                    let resultData = JSON.parse(row.dataset.result);
                    const fileContent = resultData.fileContent;

                    const prompt = buildPrompt(fileContent, newLevel);
                    const generatedResult = await callGenerativeAPI(prompt);
                    const parsedResponse = JSON.parse(generatedResult);
                    
                    if (parsedResponse.report) {
                        parsedResponse.report = parsedResponse.report.trim();
                    }

                    // UI 업데이트
                    reportCell.innerHTML = `<span class="report-text">${parsedResponse.report}</span>`;
                    
                    // 데이터셋 업데이트
                    resultData.jsonResponse = parsedResponse;
                    row.dataset.result = JSON.stringify(resultData);

                } catch (error) {
                    console.error('Error regenerating report:', error);
                    reportCell.innerHTML = `<span class="report-text text-red-500">재생성 오류: ${error.message}</span>`;
                } finally {
                    selectElement.disabled = false;
                }
            }
        });

        copyButton.addEventListener('click', () => {
            const rows = resultsTableBody.querySelectorAll('tr');
            let tsvContent = "학번\t교과세특 내용\n";
            rows.forEach(row => {
                const studentId = row.querySelector('td:first-child').innerText;
                const reportSpan = row.querySelector('.report-text');
                const textarea = row.querySelector('textarea');
                let text = '';
                if(reportSpan){
                    text = reportSpan.innerText.replace(/\n/g, " ");
                } else if (textarea){
                    text = textarea.value.replace(/\n/g, " ");
                }
                tsvContent += `${studentId}\t"${text}"\n`;
            });

            const tempTextarea = document.createElement('textarea');
            tempTextarea.value = tsvContent;
            document.body.appendChild(tempTextarea);
            tempTextarea.select();
            tempTextarea.setSelectionRange(0, 99999);

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showModalAlert('복사 완료', '결과가 클립보드에 복사되었습니다.');
                } else {
                    showModalAlert('복사 실패', '클립보드 복사에 실패했습니다.');
                }
            } catch (err) {
                showModalAlert('복사 실패', '오류로 인해 복사에 실패했습니다.');
                console.error('Clipboard copy failed:', err);
            }

            document.body.removeChild(tempTextarea);
        });
    </script>
</body>
</html>








